# ---------- deps ----------
FROM --platform=linux/amd64 node:20-slim AS deps
WORKDIR /web
COPY client/package*.json ./
# ðŸ‘‡  install *all* deps; weâ€™ll prune later
RUN npm ci               #  â¬… remove --omit=dev

# ---------- builder ----------
FROM --platform=linux/amd64 node:20-slim AS builder
WORKDIR /web
COPY --from=deps /web/node_modules ./node_modules
COPY client/. .
RUN npm run build        # succeeds because tailwind/postcss are present

# ---------- runner ----------
FROM --platform=linux/amd64 node:20-slim AS runner
WORKDIR /app
ENV NODE_ENV=production
# Optional: slim node_modules that Next copied into .next/standalone
RUN npm prune --production || true
COPY --from=builder /web/.next ./.next
COPY --from=builder /web/public ./public
COPY --from=builder /web/package*.json ./
EXPOSE 3000
CMD ["node", ".next/standalone/server.js"]
